<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=Unicode" />
        <title>SEPTA Arrivals</title>
        <style type="text/css">
        body
        {
            margin: 0;
            width: 130px;
            height: 160px;
            font-family: verdana;
            font-size: 11px;
			color:#333;
        }
        #gadgetContent
        {
            /*margin-top: 20px;*/
            width: 130px;
			height:100%;
            vertical-align: middle;
            text-align: left;
            overflow-x: hidden;
			overflow-y: auto;
			background: white;
			text-align:center;
        }
		.copyright
		{
			font-size: 9px;
		}
		h3
		{
			font-size:11px;
			display:block;
			background:#333;
			width:100%;
			color:white;
			padding:2px;
			margin:0;
			
		}
		h4{
			font-size:11px;
			margin:6px 5px 2px;
			border-bottom:1px solid #333;
		}
		.details{
			margin-bottom:8px;
		}
        </style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
        <script type="text/jscript" language="jscript">
			//Gadget init
			function init()
            {
                var oBackground = document.getElementById("imgBackground");
				//System.Gadget.settingsUI = "settings.html";
                //oBackground.src = "url(images/septa.gif)";
				//jQuery init			
				$( function() {
				  //global function
				  smsUpdate = function(smsStops) {
					for(x in smsStops) {
						//check if div element exists, otherwise append one with a unique name
						if($('#sms-'+smsStops[x]).length===0) {
							$('#target').append('<div id="sms-'+smsStops[x]+'">&nbsp;</div>');
							$('#sms-'+smsStops[x]).attr('tabIndex','-1');
						}
						var container = $('#sms-'+smsStops[x]);
						doAjaxSms(smsStops[x],container);
					}
				  }
				  
				  //global function
				  railUpdate = function(railQueries) {
					for(x in railQueries) {
						//check if div element exists, otherwise append one with a unique name
						//div_suffix = railQueries[x].replace(/[\/ ]/, '-');
						div_suffix = x;
						if($('#rail-'+div_suffix).length===0) {
							$('#target').append('<div id="rail-'+div_suffix+'">&nbsp;</div>');
						}
						var container = $('#rail-'+div_suffix );
						container.attr('tabIndex','-1');
						doAjaxRail(railQueries[x],container);
						//container.html('test');
					}
				  }
				  
				  //JSON functions derived from code by Christian Heilmann.
				  doAjaxRail = function(query,container){
					// if the URL starts with http
					url = 'http://www3.septa.org/hackathon/NextToArrive/'+query+'/2';
					if(url.match('^http')){
					  // assemble the YQL call
					  encodedCall = "http://query.yahooapis.com/v1/public/yql?"+
							"q=select%20*%20from%20json%20where%20url%3D%22"+
							encodeURIComponent(url)+
							"%22&format=json";
					  $.ajax(encodedCall, {
						dataType:'text',
						success: function(data) {
						    var obj = $.parseJSON(data);
							alert(obj);
							output = '<h3>'+query.replace(/%20/,' ').replace(/\//,' to ')+'</h3><div class="details">';
							for(x in obj.query.results.json.json) {
								output = output
								//+obj.query.results.json.json[x].orig_train+' '
								+obj.query.results.json.json[x].orig_departure_time.replace(/AM/,'a').replace(/PM/,'p')+' '
								+obj.query.results.json.json[x].orig_delay+'<br/>'
							}
							output = output + '</div>';
							container.html(output);//update div
						}
					  });
					} else {
					  container.text('test');
					  $.ajax({
						url: encodedCall,
						timeout:5000,
						requestType:'jsonp',
						success: function(data){
						  container.html(data);
						},
						error: function(req,error){
						  if(error === 'error'){error = req.statusText;}
						  var errormsg = 'There was a communication error: '+error;
							container.html(errormsg);
						}
					  });
					}
				  }
				  
				  doAjaxSms = function(stop,container){
					// if the URL starts with http
					url = 'http://www3.septa.org/sms/'+stop;
					if(url.match('^http')){
					  // assemble the YQL call
					  encodedCall = "http://query.yahooapis.com/v1/public/yql?"+
								"q=select%20*%20from%20html%20where%20url%3D%22"+
								encodeURIComponent(url)+
								"%22&format=xml&callback=?";
					  $.getJSON(encodedCall,
						function(data){
						  if(data.results[0]){
							var data = filterData(data.results[0]);
							data = "<h3>" + data;
							pattCloseTitle = new RegExp("Outbound|Inbound|Rt.");
							firstFound = pattCloseTitle.exec(data);
							data = data.replace(pattCloseTitle,'</h3>\n<div class="details">'+firstFound).replace(/Inbound/g,'<h4>Inbound</h4>').replace(/Outbound/g,'<h4>Outbound</h4>').replace(/a /g,'a<br/>').replace(/p /g,'p<br/>')+'</div>';
							container.html(data);//update div
							lastTimeRE = / [0-9]{1,2}:[0-9]{2}[ap]/g;
							while(lastTime = lastTimeRE.exec(data)) {
								lastTime = lastTime[0];
								var a_or_p = lastTime.substr(lastTime.length-1,1);
								var m = parseInt(lastTime.substr(lastTime.length-3,2));
								var h = parseInt(lastTime.substr(1,lastTime.length-4));
								if(a_or_p == 'p') {
									h = h+12;
								}
								h = h + m/60; //float h
								d = new Date();
								now = d.getHours() + d.getMinutes()/60;
								if( now-h > 0.5 ) {//half-hour buffer
									h = h + 24;//epoch is beginning of current day
								}
								if(refreshInt === undefined) {
									var refreshInt = h-now;
								}else if(h-now > refreshInt) {
									refreshInt = h-now;
								}
							}
							timeoutMs = 3600000*(refreshInt)-300000;
							if( timeoutMs < 120000 ) {
								timeoutMs = 120000; //make 2 minutes the minimum refresh time
							}
							setTimeout("doAjaxSms(" + stop + ", $('#sms-" + stop + "'));", timeoutMs);
						  } else {
							var errormsg = '<p>Error: could not load the page.</p>';
							container.html(errormsg);
						  }
						});
					} else {
					  $.ajax({
						url: url,
						timeout:5000,
						success: function(data){
						  container.html(data);
						},
						error: function(req,error){
						  if(error === 'error'){error = req.statusText;}
						  var errormsg = 'There was a communication error: '+error;
							container.html(errormsg);
						},
						beforeSend: function(data){
						}
					  });
					}
				  }
				  function filterData(data){
					data = data.replace(/(<\/?body[^>]*>)|(<\/?p>)|([\r|\n]+)/g,'');
					data = data.replace(/&amp;+/g,'&');
					data = data.replace(/<--[\S\s]*?-->/g,'');
					data = data.replace(/<noscript[^>]*>[\S\s]*?<\/noscript>/g,'');
					data = data.replace(/<script[^>]*>[\S\s]*?<\/script>/g,'');
					data = data.replace(/<script.*\/>/,'');
					return data;
				  }
				  //initialize page
				  var railQueries = ['Market%20East/Manayunk'];
				  railUpdate(railQueries);
				  var smsStops = [17855/*,16127*/];
				  smsUpdate(smsStops);
				});	
            }
			
        </script>
    </head>
    <body onload="init()">
        <g:background id="imgBackground">
            <div id="gadgetContent">
				<div id="target"></div>
			</div>
        </g:background>
    </body>
</html>