<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=Unicode" />
        <title>SEPTA Arrivals</title>
        <style type="text/css">
        body
        {
            margin: 0;
            width: 130px;
            height: 160px;
            font-family: verdana;
            font-size: 11px;
			color:#333;
        }
        #gadgetContent
        {
            /*margin-top: 20px;*/
            width: 130px;
			height:100%;
            vertical-align: middle;
            text-align: left;
            overflow-x: hidden;
			overflow-y: auto;
			background: white;
			text-align:center;
        }
		.copyright
		{
			font-size: 9px;
		}
		h3
		{
			font-size:11px;
			display:block;
			background:#333;
			width:100%;
			color:white;
			padding:2px;
			margin:0;
			
		}
		h4{
			font-size:11px;
			margin:6px 5px 2px;
			border-bottom:1px solid #333;
		}
		
        </style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
        <script type="text/jscript" language="jscript">
            // Initialize the gadget.
            
			function init()
            {
                var oBackground = document.getElementById("imgBackground");
				System.Gadget.settingsUI = "settings.html";
                //oBackground.src = "url(images/septa.gif)";
            }
			
			$( function() {
			  //JSON functions derived from code by Christian Heilmann.
			  function doAjaxSms(stop,container){
				// if the URL starts with http
				url = 'http://www3.septa.org/sms/'+stop;
				if(url.match('^http')){
				  // assemble the YQL call
				  encodedCall = "http://query.yahooapis.com/v1/public/yql?"+
							"q=select%20*%20from%20html%20where%20url%3D%22"+
							encodeURIComponent(url)+
							"%22&format=xml'&callback=?";
				  $.getJSON("http://query.yahooapis.com/v1/public/yql?"+
							"q=select%20*%20from%20html%20where%20url%3D%22"+
							encodeURIComponent(url)+
							"%22&format=xml'&callback=?",
					function(data){
					  if(data.results[0]){
						var data = filterData(data.results[0]);
						data = "<h3>" + data;
						pattCloseTitle = new RegExp("Outbound|Inbound|Rt.");
						firstFound = pattCloseTitle.exec(data);
						data = data.replace(pattCloseTitle,'</h3>\n' + firstFound);
						data = data.replace(/Inbound/g,'<h4>Inbound</h4>');
						data = data.replace(/Outbound/g,'<h4>Outbound</h4>');
						data = data.replace(/a /g,'a<br/>');
						data = data.replace(/p /g,'p<br/>');
						container.html(data);
						var lastTime = /[0-9:]+(a|p)[^@]*$/g.exec(data);
						lastTime = lastTime[0].replace(/(<br\/?>)/g, '');
						var a_or_p = lastTime.substr(lastTime.length-2,1);
						var m = parseInt(lastTime.substr(lastTime.length-4,2));
						var h = parseInt(lastTime.substr(0,lastTime.length-5));
						if(a_or_p == 'p') {
							var h = h+12;
						}
						lastBus = h + m/60;
						d = new Date();
						now = d.getHours() + d.getMinutes()/60;
						//if lastBus is less than current time, it's the next day, so add 24h to current time
						if( lastBus < now ) {
							lastBus = lastBus + 24;
						}
						timeoutMs = 3600000*(lastBus - now)-300000;
						if( timeoutMs < 120000 ) {
							timeoutMs = 120000; //make 2 minutes the minimum refresh time
						}
						setTimeout("updateSms(" + stop + ");", timeoutMs);//set timeout / convert hours to ms, less 5 min
					  } else {
						var errormsg = '<p>Error: could not load the page.</p>';
						container.html(errormsg);
					  }
					}
				  );
				} else {
				  $.ajax({
					url: url,
					timeout:5000,
					success: function(data){
					  container.html(data);
					},
					error: function(req,error){
					  if(error === 'error'){error = req.statusText;}
					  var errormsg = 'There was a communication error: '+error;
						container.html(errormsg);
					},
					beforeSend: function(data){
					}
				  });
				}
			  }
			  function filterData(data){
				// filter all the nasties out
				// no body tags, linebreaks, p tags
				data = data.replace(/(<\/?body[^>]*>)|(<\/?p>)|([\r|\n]+)/g,'');
				// decode ampersands
				data = data.replace(/&amp;+/g,'&');
				// no comments
				data = data.replace(/<--[\S\s]*?-->/g,'');
				// no noscript blocks
				data = data.replace(/<noscript[^>]*>[\S\s]*?<\/noscript>/g,'');
				// no script blocks
				data = data.replace(/<script[^>]*>[\S\s]*?<\/script>/g,'');
				// no self closing scripts
				data = data.replace(/<script.*\/>/,'');
				return data;
			  }
			  smsUpdate = function(smsStops) {
				for(x in smsStops) {
					//check if div element exists, otherwise append one with a unique name
					if($('#sms-'+smsStops[x]).length===0) {
						$('#target').append('<div id="sms-'+smsStops[x]+'"></div>');//make that container!
					}
					var container = $('#sms-'+smsStops[x]);
					container.attr('tabIndex','-1');
					doAjaxSms(smsStops[x],container);
				}
			  }
			  //initialize page
			  var smsStops = [18393,2];
			  smsUpdate(smsStops);
			});	
        </script>
    </head>
	
    <body onload="init()">
        <g:background id="imgBackground">
            <div id="gadgetContent">
				<div id="target"></div>
			</div>
        </g:background>
    </body>
</html>